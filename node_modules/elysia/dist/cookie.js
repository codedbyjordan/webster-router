// @ts-ignore
import{parse as e}from"cookie";import{unsignCookie as t}from"./utils";import{InvalidCookieSignature as r}from"./error";export class Cookie{_value;property;name;setter;constructor(e,t={}){this._value=e,this.property=t}get(){return this._value}get value(){return this._value}set value(e){if("object"==typeof e){if(JSON.stringify(this.value)===JSON.stringify(e))return}else if(this.value===e)return;this._value=e,this.sync()}add(e){let t=Object.assign(this.property,"function"==typeof e?e(Object.assign(this.property,this.value)):e);return"value"in t&&(this._value=t.value,delete t.value),this.property=t,this.sync()}set(e){let t="function"==typeof e?e(Object.assign(this.property,this.value)):e;return"value"in t&&(this._value=t.value,delete t.value),this.property=t,this.sync()}remove(e){void 0!==this.value&&this.set({domain:e?.domain,expires:new Date(0),maxAge:0,path:e?.path,sameSite:e?.sameSite,secure:e?.secure,value:""})}get domain(){return this.property.domain}set domain(e){// @ts-ignore
this.property.domain!==e&&(// @ts-ignore
this.property.domain=e,this.sync())}get expires(){return this.property.expires}set expires(e){// @ts-ignore
this.property.expires?.getTime()!==e?.getTime()&&(// @ts-ignore
this.property.expires=e,this.sync())}get httpOnly(){return this.property.httpOnly}set httpOnly(e){// @ts-ignore
this.property.domain!==e&&(// @ts-ignore
this.property.httpOnly=e,this.sync())}get maxAge(){return this.property.maxAge}set maxAge(e){// @ts-ignore
this.property.maxAge!==e&&(// @ts-ignore
this.property.maxAge=e,this.sync())}get path(){return this.property.path}set path(e){// @ts-ignore
this.property.path!==e&&(// @ts-ignore
this.property.path=e,this.sync())}get priority(){return this.property.priority}set priority(e){// @ts-ignore
this.property.priority!==e&&(// @ts-ignore
this.property.priority=e,this.sync())}get sameSite(){return this.property.sameSite}set sameSite(e){// @ts-ignore
this.property.sameSite!==e&&(// @ts-ignore
this.property.sameSite=e,this.sync())}get secure(){return this.property.secure}set secure(e){// @ts-ignore
this.property.secure!==e&&(// @ts-ignore
this.property.secure=e,this.sync())}toString(){return"object"==typeof this.value?JSON.stringify(this.value):this.value?.toString()??""}sync(){return this.name&&this.setter&&(this.setter.cookie?this.setter.cookie[this.name]=Object.assign(this.property,{value:this.toString()}):this.setter.cookie={[this.name]:Object.assign(this.property,{value:this.toString()})}),this}}export const createCookieJar=(e,t,r)=>new Proxy(e,{get(e,i){if(i in e)return e[i];// @ts-ignore
    let s=new Cookie(void 0,r?{...r}:void 0);// @ts-ignore
    return(// @ts-ignore
    s.setter=t,s.name=i,s)},set:(e,r,i)=>i instanceof Cookie&&(t.cookie||(t.cookie={}),// @ts-ignore
        i.setter=t,i.name=r,// @ts-ignore
        i.sync(),e[r]=i,!0)});export const parseCookie=async(i,s,{secret:o,sign:p,...n}={})=>{if(!s)return createCookieJar({},i,n);let a={},h="string"==typeof o;p&&!0!==p&&!Array.isArray(p)&&(p=[p]);let y=Object.keys(e(s));for(let u=0;u<y.length;u++){let c=y[u],l=e(s)[c];if(!0===p||p?.includes(c)){if(!o)throw Error("No secret is provided to cookie plugin");if(h)// @ts-ignore
{if(!1===// @ts-ignore
(l=await t(l,o)))throw new r(c)}else{let e=!0;for(let r=0;r<o.length;r++){let i=await t(l,o[r]);if(!1!==i){l=i,e=!1;break}}if(e)throw new r(c)}}if(void 0===l)continue;let m=l.charCodeAt(0);if(123===m||91===m)try{let e=new Cookie(JSON.parse(l));// @ts-ignore
e.setter=i,e.name=c,a[c]=e;continue}catch{// Not empty
}Number.isNaN(+l)?"true"===l?l=!0:"false"===l&&(l=!1):l=+l;let g=new Cookie(l,n);// @ts-ignore
g.setter=i,g.name=c,a[c]=g}return createCookieJar(a,i)};