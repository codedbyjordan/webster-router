import{Kind as e}from"@sinclair/typebox";import{Value as r}from"@sinclair/typebox/value";import{TypeCompiler as t}from"@sinclair/typebox/compiler";import{isNotEmpty as o}from"./handler";let a=e=>e&&"object"==typeof e&&!Array.isArray(e);export const getHostname=e=>e.slice(0,e.indexOf("/",11));let n=e=>"function"==typeof e&&/^\s*class\s+/.test(e.toString())||// Handle import * as Sentry from '@sentry/bun'
    // This also handle [object Date], [object Array]
    // and FFI value like [object Prisma]
    e.toString().startsWith("[object ")||// If object prototype is not pure, then probably a class-like object
    o(Object.getPrototypeOf(e));export const mergeDeep=(e,r,{skipKeys:t}={})=>{if(a(e)&&a(r)){for(let[o,s]of Object.entries(r))if(!t?.includes(o)){if(!a(s)||!(o in e)||n(s)){e[o]=s;continue}e[o]=mergeDeep(e[o],s)}}return e};export const mergeCookie=(e,r)=>mergeDeep(e,r,{skipKeys:["properties"]});export const mergeObjectArray=(e,r)=>{// ! Must copy to remove side-effect
let t=[...Array.isArray(e)?e:[e]],o=[];for(let e of t)// @ts-ignore
e.$elysiaChecksum&&// @ts-ignore
o.push(e.$elysiaChecksum);for(let e of Array.isArray(r)?r:[r])// @ts-ignore
o.includes(e?.$elysiaChecksum)||t.push(e);return t};export const mergeHook=(e,r)=>({// Merge local hook first
    // @ts-ignore
    body:r?.body??e?.body,// @ts-ignore
    headers:r?.headers??e?.headers,// @ts-ignore
    params:r?.params??e?.params,// @ts-ignore
    query:r?.query??e?.query,// @ts-ignore
    response:r?.response??e?.response,type:e?.type||r?.type,detail:mergeDeep(// @ts-ignore
    r?.detail??{},// @ts-ignore
    e?.detail??{}),parse:mergeObjectArray(e?.parse??[],r?.parse??[]),transform:mergeObjectArray(e?.transform??[],r?.transform??[]),beforeHandle:mergeObjectArray(e?.beforeHandle??[],r?.beforeHandle??[]),afterHandle:mergeObjectArray(e?.afterHandle??[],r?.afterHandle??[]),onResponse:mergeObjectArray(e?.onResponse??[],r?.onResponse??[]),trace:mergeObjectArray(e?.trace??[],r?.trace??[]),error:mergeObjectArray(e?.error??[],r?.error??[])});export const getSchemaValidator=(e,{models:o={},additionalProperties:a=!1,dynamic:n=!1})=>{if(!e||"string"==typeof e&&!(e in o))return;let s="string"==typeof e?o[e]:e;return("object"===s.type&&"additionalProperties"in s==!1&&(s.additionalProperties=a),n)?{schema:s,references:"",checkFunc:()=>{},code:"",Check:e=>r.Check(s,e),Errors:e=>r.Errors(s,e),Code:()=>""}:t.Compile(s,Object.values(o))};export const getResponseSchemaValidator=(o,{models:a={},additionalProperties:n=!1,dynamic:s=!1})=>{if(!o||"string"==typeof o&&!(o in a))return;let i="string"==typeof o?a[o]:o,l=(e,o)=>s?{schema:e,references:"",checkFunc:()=>{},code:"",Check:t=>r.Check(e,t),Errors:t=>r.Errors(e,t),Code:()=>""}:t.Compile(e,o);if(e in i)return"additionalProperties"in i==!1&&(i.additionalProperties=n),{200:l(i,Object.values(a))};let p={};return Object.keys(i).forEach(r=>{let t=i[+r];if("string"==typeof t){if(t in a){let o=a[t];o.type,// Inherits model maybe already compiled
p[+r]=e in o?l(o,Object.values(a)):o}return}"object"===t.type&&"additionalProperties"in t==!1&&(t.additionalProperties=n),// Inherits model maybe already compiled
p[+r]=e in t?l(t,Object.values(a)):t}),p};// https://stackoverflow.com/a/52171480
export const checksum=e=>{let r=9;for(let t=0;t<e.length;)r=Math.imul(r^e.charCodeAt(t++),387420489);return r^r>>>9};export const mergeLifeCycle=(e,r,t)=>{let o=e=>(t&&!e.$elysiaChecksum&&// @ts-ignore
    (e.$elysiaChecksum=t),e);return{start:mergeObjectArray(e.start,("start"in r?r.start??[]:[]).map(o)),request:mergeObjectArray(e.request,("request"in r?r.request??[]:[]).map(o)),parse:mergeObjectArray(e.parse,"parse"in r?r?.parse??[]:(void 0)??[]).map(o),transform:mergeObjectArray(e.transform,(r?.transform??[]).map(o)),beforeHandle:mergeObjectArray(e.beforeHandle,(r?.beforeHandle??[]).map(o)),afterHandle:mergeObjectArray(e.afterHandle,(r?.afterHandle??[]).map(o)),onResponse:mergeObjectArray(e.onResponse,(r?.onResponse??[]).map(o)),trace:e.trace,// trace: mergeObjectArray(
// 	a.trace as any,
// 	('trace' in b ? b.trace ?? [] : ([] as any)).map(injectChecksum)
// ),
error:mergeObjectArray(e.error,(r?.error??[]).map(o)),stop:mergeObjectArray(e.stop,("stop"in r?r.stop??[]:[]).map(o))}};export const asGlobalHook=(e,r=!0)=>({// rest is validator
    ...e,type:e?.type,detail:e?.detail,parse:asGlobal(e?.parse,r),transform:asGlobal(e?.transform,r),beforeHandle:asGlobal(e?.beforeHandle,r),afterHandle:asGlobal(e?.afterHandle,r),onResponse:asGlobal(e?.onResponse,r),error:asGlobal(e?.error,r)});export const asGlobal=(e,r=!0)=>e?"function"==typeof e?(r?// @ts-ignore
    e.$elysiaHookType="global":e.$elysiaHookType=void 0,e):e.map(e=>(r?// @ts-ignore
        e.$elysiaHookType="global":e.$elysiaHookType=void 0,e)):e;let s=e=>e?"function"==typeof e?"global"===e.$elysiaHookType?e:void 0:e.filter(e=>"global"===e.$elysiaHookType):e;export const filterGlobalHook=e=>({// rest is validator
    ...e,type:e?.type,detail:e?.detail,parse:s(e?.parse),transform:s(e?.transform),beforeHandle:s(e?.beforeHandle),afterHandle:s(e?.afterHandle),onResponse:s(e?.onResponse),error:s(e?.error)});export const StatusMap={Continue:100,"Switching Protocols":101,Processing:102,"Early Hints":103,OK:200,Created:201,Accepted:202,"Non-Authoritative Information":203,"No Content":204,"Reset Content":205,"Partial Content":206,"Multi-Status":207,"Already Reported":208,"Multiple Choices":300,"Moved Permanently":301,Found:302,"See Other":303,"Not Modified":304,"Temporary Redirect":307,"Permanent Redirect":308,"Bad Request":400,Unauthorized:401,"Payment Required":402,Forbidden:403,"Not Found":404,"Method Not Allowed":405,"Not Acceptable":406,"Proxy Authentication Required":407,"Request Timeout":408,Conflict:409,Gone:410,"Length Required":411,"Precondition Failed":412,"Payload Too Large":413,"URI Too Long":414,"Unsupported Media Type":415,"Range Not Satisfiable":416,"Expectation Failed":417,"I'm a teapot":418,"Misdirected Request":421,"Unprocessable Content":422,Locked:423,"Failed Dependency":424,"Too Early":425,"Upgrade Required":426,"Precondition Required":428,"Too Many Requests":429,"Request Header Fields Too Large":431,"Unavailable For Legal Reasons":451,"Internal Server Error":500,"Not Implemented":501,"Bad Gateway":502,"Service Unavailable":503,"Gateway Timeout":504,"HTTP Version Not Supported":505,"Variant Also Negotiates":506,"Insufficient Storage":507,"Loop Detected":508,"Not Extended":510,"Network Authentication Required":511};export const signCookie=async(e,r)=>{if("string"!=typeof e)throw TypeError("Cookie value must be provided as a string.");if(null===r)throw TypeError("Secret key must be provided.");let t=new TextEncoder,o=await crypto.subtle.importKey("raw",t.encode(r),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),a=await crypto.subtle.sign("HMAC",o,t.encode(e)),n=Array.from(new Uint8Array(a)),s=btoa(String.fromCharCode(...n));return`${e}.${s.replace(/=+$/,"")}`};export const unsignCookie=async(e,r)=>{if("string"!=typeof e)throw TypeError("Signed cookie string must be provided.");if(null===r)throw TypeError("Secret key must be provided.");let t=e.slice(0,e.lastIndexOf(".")),o=await signCookie(t,r);return o===e&&t};